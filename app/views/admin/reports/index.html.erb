<% content_for :meta_title, "Reports Dashboard - Admin | Red Tape LA" %>
<% content_for :meta_description, "Admin dashboard for managing Red Tape LA reports. View, review, and track submitted reports." %>

<div class="container">
  <h1>Red Tape Reports Dashboard</h1>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-number"><%= @total_approved %></div>
      <div class="stat-label">Approved Reports</div>
    </div>
    <div class="stat-card <%= 'stat-card--pending' if @pending_review_count > 0 %>">
      <div class="stat-number"><%= @pending_review_count %></div>
      <div class="stat-label">Pending Review</div>
    </div>
    <div class="stat-card">
      <div class="stat-number"><%= @unverified_count %></div>
      <div class="stat-label">Unverified</div>
    </div>
  </div>

  <!-- Export Section -->
  <div class="card" style="margin-bottom: 1.5rem; background-color: #f9fafb;">
    <h2 style="margin-top: 0; margin-bottom: 1rem; font-size: 1.25rem; color: var(--la-navy);">Generate Bi-Monthly Report</h2>
    <p style="margin-bottom: 1rem; color: var(--la-muted);">Export approved reports from a date range for your advocacy work.</p>

    <div data-controller="export">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
        <div>
          <label for="start_date" style="display: block; font-weight: 600; margin-bottom: 0.25rem;">Start Date</label>
          <input type="date" data-export-target="startDate" value="<%= 2.months.ago.to_date %>" style="width: 100%; padding: 0.5rem; border: 2px solid #ccc; border-radius: 4px;">
        </div>
        <div>
          <label for="end_date" style="display: block; font-weight: 600; margin-bottom: 0.25rem;">End Date</label>
          <input type="date" data-export-target="endDate" value="<%= Date.today %>" style="width: 100%; padding: 0.5rem; border: 2px solid #ccc; border-radius: 4px;">
        </div>
      </div>

      <div style="display: flex; gap: 0.75rem;">
        <button data-action="click->export#exportCsv" type="button" class="btn-primary" style="background-color: var(--la-navy); color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; width: auto;">Export CSV</button>
        <button data-action="click->export#exportPdf" type="button" class="btn-primary" style="background-color: #E6AF2E; color: var(--la-charcoal); padding: 0.75rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; width: auto;">Generate PDF Report</button>
      </div>
    </div>
  </div>

  <div class="filter-tabs">
    <%= link_to "All", admin_reports_path(filter: "all"),
        class: "filter-tab #{@filter == 'all' ? 'filter-tab--active' : ''}" %>
    <%= link_to "Pending Review", admin_reports_path(filter: "pending_review"),
        class: "filter-tab #{@filter == 'pending_review' ? 'filter-tab--active' : ''}" %>
    <%= link_to "Approved", admin_reports_path(filter: "approved"),
        class: "filter-tab #{@filter == 'approved' ? 'filter-tab--active' : ''}" %>
    <%= link_to "Unverified", admin_reports_path(filter: "unverified"),
        class: "filter-tab #{@filter == 'unverified' ? 'filter-tab--active' : ''}" %>
  </div>

  <!-- Active Filters -->
  <% if @filter_email.present? || @filter_department.present? || @filter_issue_category.present? %>
    <div style="margin: 1rem 0; padding: 1rem; background-color: #f0f8fb; border: 1px solid #0b3d66; border-radius: 4px;">
      <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
        <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
          <strong style="color: var(--la-navy);">Active filters:</strong>
          <% if @filter_email.present? %>
            <span style="background-color: white; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.875rem; display: inline-flex; align-items: center; gap: 0.5rem;">
              <strong>Email:</strong> <%= @filter_email %>
              <%= link_to "×", admin_reports_path(filter: @filter, department: @filter_department, issue_category: @filter_issue_category), style: "color: #dc2626; text-decoration: none; font-size: 1.25rem; font-weight: bold; margin-left: 0.25rem;" %>
            </span>
          <% end %>
          <% if @filter_department.present? %>
            <span style="background-color: #FEF4E6; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.875rem; display: inline-flex; align-items: center; gap: 0.5rem;">
              <strong>Department:</strong> <%= @filter_department %>
              <%= link_to "×", admin_reports_path(filter: @filter, email: @filter_email, issue_category: @filter_issue_category), style: "color: #dc2626; text-decoration: none; font-size: 1.25rem; font-weight: bold; margin-left: 0.25rem;" %>
            </span>
          <% end %>
          <% if @filter_issue_category.present? %>
            <span style="background-color: #E7F6F8; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.875rem; display: inline-flex; align-items: center; gap: 0.5rem;">
              <strong>Issue:</strong> <%= @filter_issue_category %>
              <%= link_to "×", admin_reports_path(filter: @filter, email: @filter_email, department: @filter_department), style: "color: #dc2626; text-decoration: none; font-size: 1.25rem; font-weight: bold; margin-left: 0.25rem;" %>
            </span>
          <% end %>
        </div>
        <%= link_to "Clear all filters", admin_reports_path(filter: @filter), style: "color: var(--la-navy); text-decoration: underline; font-size: 0.875rem; font-weight: 600;" %>
      </div>
    </div>
  <% end %>

  <div class="card">
    <% if @reports.any? %>
      <table class="reports-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Email</th>
            <th>Project Type</th>
            <th>Location</th>
            <th>Status</th>
            <th>Submitted</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <% @reports.each do |report| %>
            <tr>
              <td data-label="ID"><strong>#<%= report.id %></strong></td>
              <td data-label="Email"><%= link_to report.email, admin_reports_path(email: report.email, filter: @filter), style: "color: var(--la-navy); text-decoration: underline;" %></td>
              <td data-label="Project Type"><%= report.project_type %></td>
              <td data-label="Location"><%= truncate(report.location, length: 40) %></td>
              <td data-label="Status">
                <% if report.approved? %>
                  <span class="status-badge status-badge--approved">Approved</span>
                <% elsif report.verified? %>
                  <span class="status-badge status-badge--pending">Pending Review</span>
                <% else %>
                  <span class="status-badge status-badge--unverified">Unverified</span>
                <% end %>
              </td>
              <td data-label="Submitted" class="text-small">
                <%= time_ago_in_words(report.created_at) %> ago
              </td>
              <td data-label="">
                <%= link_to "View", admin_report_path(report), class: "btn-link" %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div class="usa-prose--empty">
        <p class="text-small">No reports submitted yet.</p>
      </div>
    <% end %>
  </div>
</div>
